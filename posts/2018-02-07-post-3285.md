---
title: Deepfakes の作り方から学ぶ機械学習と SNS などの画像公開の危険性
author: KEINOS
type: post
date: 2018-02-06T16:54:22+00:00
excerpt: 以前よりフォトショップ職人であれば、フェイク画像や動画は作れていたのですが、やはり加工技術や大変な手間が必要とされていました。Deepfakesは従来からある技術のただのマッシュアップですが、そのDeepfakesの作り方から学ぶ機械学習／ディープラーニングの使い方や、改めて個人情報のあり方について考察します。
url: /20180207_3285
featured_image: /wp-content/uploads/2018/02/deeplearning.png
yuzo_related_post_metabox:
  - 'a:3:{s:17:"yuzo_include_post";s:0:"";s:17:"yuzo_exclude_post";s:0:"";s:21:"yuzo_disabled_related";N;}'
page_type:
  - default
post_views_count:
  - 12260
categories:
  - アルゴリズム・仕組み
  - 機械学習/DNN
tags:
  - deepfakes
  - faceswap
  - ニューラルネットワーク

---
このページは Deepfakes/FaceSwap の概要と仕組みを解説した記事です。具体的な作り方は「[Deepfakes/FaceSwapの作り方 実施編 （Mac OSX）][1]」をご覧ください。

## Deepfakes/FaceSwap とは {#outline__1}

&#8220;Deepfakes/FaceSwap&#8221; とは、与えた画像や動画を元に深層学習（ディープラーニング）を行い、異なる人物の顔を入れ替る技術/手法、またはそのコンテンツを言います。

元々は 2017/09/27 にソーシャル・ブックマークサイトの [Reddit の &#8220;/u/deepfakes&#8221; というユーザー][2]が投稿した動画が発祥で、ディープラーニングで学習させた有名な女優の顔を、H な動画の女優と顔を入れ替えた動画をアップして話題になったことから始まったムーブメントで、このユーザーをリスペクトして、[ディープラーニングで遊んだコンテンツ][3]を &#8220;Deepfakes&#8221; と一部で言われるようになりました。なぜかいつもニコラス・ケイジがネタに使われます。本人のプロモーションとして容認（黙認）しているのであれば、成功しているのではないでしょうか。

昔で言う、[コラ][4]動画の**職人技を機械学習で行える時代になった**ということが、やはり話題の根源にあるようです。

ここでもまた AI が職人の職を奪うということなのでしょうか。はたまた、 [VHS][5] やインターネットや [P2P][6] などのように、繁栄の裏にあった表には出せない大人（18禁）の事情なのでしょうか。

## Deepfakes/FaceSwap の違法性 {#outline__2}

**罰すべきは、違法動画をあげた人**であって技術ではないはずです。

その例として、[`Winny`][7] の開発者の故[金子勇][8]氏のように、[裁判で勝訴][9]するも 7 年もの時間を無駄にされ、これから新しい技術を開発するという時に亡くなる一方、同じ P2P 技術のアプリで同じように裁判にかけられ、しかも敗訴した [Napstar][10]の[ショーン・パーカー][11] 氏は Facebook の初代 CEO になったり、[Plaxo][12] を立ち上げたり、 フォーブスにも掲載される投資家になって [Spotify][13] に出資したりと、新しい技術に貢献しているのです。

昨今騒がれている IoT や仮想通貨（むしろブロックチェーン）なども、P2P 含む分散技術が不可欠です。金子氏が失った時間と、金子氏を失ったことは、日本の P2P の技術の発展を遅らせた原因の１つと言うのは過言ではないと思います。

国も文化も違うのでいちがいに比較はできません。しかし、同じ 7 年の間に、この二人にこれだけの差がついたのも、例えれば「**革新的な包丁の研ぎ方の技術を教えることは、包丁を使った犯罪犯の幇助」と同一視するような過ちの結果**なのです。

そして、この Deepfakes/FaceSwap の技術を使って「違法な動画」を面白半分でアップするということは、**包丁の研ぎ方を観て、切れ味を試そうと人を刺してしまうのと同じこと**です。また、腹いせで合成して擬似リベンジ・ポルノをアップするということも、「果物ナイフなら死なないだろう」と腹いせで刺してしまうのと変わりません。包丁は、ちゃんと料理に使うものです。

> 追記：ここまで書いてツイッターで「刀は人を斬るものじゃんww」とか言う人がいるようです。「マリファナは海外じゃ合法じゃん」と言って日本で吸ってしまう以上に愚かです。ポイントを理解してもらえないのが悲しいです。
    
> しかし、それが故にこの記事を書いたとも言えます。
    
> 確かに、銃の問題のように「そもそも持たせなきゃいいじゃん」という見かたもあるかもしれません。つまり、**悪い要素の割合が大きい場合は、致し方なく規制をする必要も出てくる**でしょう。特に、早い段階で悪い要素の芽を摘むために「見せしめ」的に軽い犯罪を厳しく取り締まることもあると思います。
    
> しかし「見せしめ」とは「そもそも理解が出来る人に釘を刺す効果」しかありません。
    
> 全校朝礼で「昨日、万引きをした生徒がいます」とアナウンスしたところで、万引きがなくなるわけではないのと似ていると思います。万引きでなくイジメやパワハラでもいいでしょう。**知っていても理解できないから効果がない**のです。つまり「聞いたことがある」程度の認知でしかないのです。犯行の当事者になっても理解できないこともあるかもしれません。
    
> そういった潜在的な犯罪者予備軍をディープラーニングで検知できないものでしょうか。なぜなら、**パターンを見つけることがディープラーニングの真骨頂**だからです。（と言いながら、その予備軍にノミネートされたりして、、、そうなったら私は受け入れることが出来るのかしら） 

大事なのは、[スティーブ・ウォズニアック][14]氏の「[幸福の公式『H＝S－F』][15]」に乗っ取り、みんなが幸福（**H**=Happy）になるには、笑顔になる要素（**S**=スマイル）を増やし、悪い要素（**F**=不快感, frowns）を減らしていくことであり、**要素がわからないからと全ての要素に蓋をすることではない**のです。

## Deepfakes/FaceSwap の技術と応用 {#outline__3}

ニュースサイトでは新技術的な報道がされましたが、**すでにある一般的な技術のマッシュアップ（組み合わせ）に過ぎません**。

例えば、[写真の顔を入れ替えるアプリで撮った画像][16]を、お笑い芸能人が[インスタ][17]や [twitter][18] などにアップしたりするのが 2016 〜 2017 年に流行りましたが、この顔の入れ替えを動画に応用したものです。

動画に応用と言っても、動画は連続した静止画の集まりです。つまり、コマ毎に画像を一旦出力して顔の入れ替え処理を行ったのち、動画に戻すだけなので応用と言うほどでもありません。また、ディープラーニングを使って顔の歪み（顔の傾き、表情による眉や口の位置ずれ）を学習させておき、顔の入れ替えを行う際に反映させることでリアリティを出しているのです。

従来の技術を使っているにも関わらず、ここまで話題になったのも先に述べたような、いわゆる**職人**と呼ばれる人たちの手によってではなく、プログラムでここまでリアルなもの（フェイク）がある程度簡単に出来るようになったことにより、今後、大量なフェイク動画がリリースされることへのメディア（や著作権・肖像権ホルダー）による懸念からだと思います。テレビ、ビデオ、CD、DVD、電子書籍、音楽配信、動画配信などの技術が生まれた時と同じ懸念の繰り返しです。

しかし、[スターウォーズ「ローグ・ワン」のターキン総督][19]の様に故人の CGI 合成、スタントなどの顔の入れ替え、もしくは、アニメーションや漫画などにも応用されていくでしょう。

例えば、顔の向きや傾きの**アタリで書いたアニメーションや漫画に、後からキャラクターの顔を合成する**などです。

おそらく、これだけでは「ケンシロウの顔を学習させて、他の漫画の顔と入れ替えて」といったイタズラを思いつくかもしれません。しかし、これはキャラクターの権利を持つ原作者が嫌だと不快に思ったのであれば、やはりダメなのです。

そこで、もう少しポシティブかつクリエイティブな用途に考えてみたいと思います。

手塚治虫先生が取り入れた「[スター・システム][20]」は、サブ・キャラクターやモブを助演俳優として扱うことで、生産コストを下げ、**ストーリーに注力できたことで名作を量産できた**という実績があります。

例えば、自作のキャラの顔を学習をしたモデル（学習データ）を提供して、キャラ作りが苦手だけどストーリー作りが得意な他の作家さんに利用してもらうなどの、新しいタイプのスター・システムに応用できると思います。そのモデルはそのままアニメにも使えるでしょう。

つまり、使い方次第で作業費/人件費を減らすことが期待できるポテンシャルを持った総合技術なのです。

どのように顔を識別し入れ替えるのかといった処理自体の技術については、英語ですが、以下の動画は良くまとまっていると思います。

<div class="youtube">
  <span class="embed-youtube" style="text-align:center; display: block;"><iframe class='youtube-player' type='text/html' width='1100' height='619' src='https://www.youtube.com/embed/7XchCsYtYMQ?version=3&#038;rel=1&#038;fs=1&#038;autohide=2&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' allowfullscreen='true' style='border:0;'></iframe></span>
</div>

## SNS へ顔写真をあげる危険性 {#outline__4}

作品のコラボレーションとも言える[コーラージュ][21]技法は古くからあり、その技法を使ってのフェイク画像は昔から作られていました。写真をカットして貼り付けたり、フォトショ職人と呼ばれるフォトショップの達人たちによって作られていたのですが、やはり加工技術が必要だったり動画の場合はさらに大変な手間を必要としていました。しかし、現在では以下の４つの事ができれば、顔の入れ替え動画を比較的簡単に作る事が可能です。

  1. 動画から静止画の抽出
  2. 静止画から顔の抽出
  3. 抽出した顔の入れ替え
  4. 連続した画像から動画の再作成

先にも言ったように上記のほとんどは以前からある技術です。つまり、入れ替える素材（写真画像）があれば作れてしまうので、インターネットへの写真公開はジャニーズ並に気を配る必要がある時代かもしれません。「デートなう　に使っていいよ」と写真を公開して本当に使われてクレームを入れるような安易な人は要注意だと思います。

## 機械学習の基本 {#outline__5}

さて、機械学習といってもピンと来ないかもしれません。「まぁ、機械に学習させるってことなんだろうな」くらいの認識かもしれません。まぁ、そうなんですが。

機械学習の基本的な動作として「A と B という条件があった場合、次は何が起こる？」という質問に「X % の確率で C が起きます」といった答えを得るために、「過去にどのような条件で、どのような結果が起きたか」の**確率データをストックすることを学習**と言います。

例えば、中学生の時に「サイコロの １ の目が出る確率は 1/6」という確率の検証で、何度もサイコロを振っていくと限りなく 1/6 に近づいていくといった実験をさせられたことがあると思います。この実験と同じように、コンピューターに何度も検証させて「どうやらサイコロの 1 の目が出る確率は 1/6 に近い**らしい**」という、検証の繰り返しによる確率を導き出すイメージです。

実際には、脳の仕組みを取り入れたり、もっと複雑な処理なのですが、今まで「A と来たら B」と条件を１つ１つプログラミングしないといけなかったことが、データを渡すだけで学習して、プログラム自身が「A と来たら B」と気づき、間違っていたら修正も行い精度を高める事ができるようになったのです。

具体的な事例でいうと、Wikipedia にある全ての文字データを学習させ、「フランス、パリという条件があった場合、日本の次には何がくるか？」という、謎かけ的な質問に「東京」という、「国名→首都名」の関係を踏まえた結果が得られるようになります。これは、Wikipedia の膨大なテキストから「A → B」という関係の類似性が「C → D」と似ていると学習したことによるものです。

以上はテキストの場合ですが、画像の場合は与えた画像から「〜らしい」という学習をさせることになります。例えば「これはマリリン・モンローらしい」という判断をさせたり、「マリリン・モンローらしい」ように画像を補完をさせると口元にホクロを付けたりできます。つまり、与えられた画像から特徴を学習できるのです。これらの特徴を学習したデータをモデル（あるいはデータモデル）と言います。

## Deepfakes/SwapFace の作り方 {#outline__6}

２つの顔を単純に入れ替えるだけなら、各々の顔の位置を割り出し、その範囲の画像を入れ替えるだけです。 [twitter にある顔入れ替え][16]を見ればわかるのですが、入れ替える画像によっては無理やり引き伸ばしたりするので無理が生じます。

そこで、あらかじめ大量の同一人物の画像から、顔の向きや、動画の場合には前後の画像から動き（歪みの遷移）を学習させることで、より精度の高い入れ替えが出来るようになります。

  1. 人物 A の画像と動画で顔を深層学習させる
  2. 人物 B の画像と動画で顔を深層学習させる
  3. 人物 A の動画の顔を B と入れ替える

上記は大枠の流れなのですが、画像と動画の ２ 種類のコンテンツを学習させる理由は、画像は顔の認識、動画は顔の動きと歪みを学習させるためです。つまり、「この顔は、この状態だと、このように歪む」という学習をさせモデルを作り、別の素材を適用すると同様に歪ませることができます。あとは、歪ませた顔を入れ替えるというシンプルなものです。（簡単とは言っていない）

### 特徴の学習 {#outline__6_1}

  * 画像から顔の部分を抽出
  * 抽出された顔から人物の特徴（共通項）を学習

### 歪み（顔の傾き）の学習 {#outline__6_2}

  * 動画から１コマずつ画像を抽出
  * 抽出した画像から顔を検知
  * 連続画像から顔の動きのパターンを抽出
  * 検知した顔と先に学習した特徴から、顔の傾き（歪み）を学習

上記の処理を行い、モデルを作成し、「もし A というモデルを　B に適用したらどうなる」という処理を行うわけです。

## Deepfakes/FaceSwap に必要なもの {#outline__7}

今回の記事では具体的な作り方手順は言及しません（<del>パート２ で書くかもです</del>[書きました][22]）が、以下は Mac の場合に必要なものです。おそらく Windows や Linux/Unix でも基本的に同じで、有名な企業のソフトウェアであることがわかると思います。また、ライブラリとは用途ごとにわけたプログラムの集合体のことを言います。

  * [FFmpeg][23] 
      * 動画と音声を記録・変換・再生するオープンソースのソフトウェア。動画から静止画を抽出、または連続した静止画を動画に変換するのに使う。
  * [OpenCV][24] 
      * Intel 社の画像処理・解析および機械学習のオープンソースのライブラリ。画像をさまざま状態で解析でき、画像から顔のエリア（範囲）を検出するのに使う。
  * [Tensorflow][25] 
      * Google 社の汎用的な機械学習のオープンソースのライブラリで、[ディープラーニング/深層学習][26]に対応しているのが特徴。主に、顔の入れ替えを行う際に、画像間の差異を学習するのに使われる。
  * GPU ドライバ/[CUDA][27] 
      * 深層学習を行う際に、アプリの演算処理（並列計算）を GPU で行うためのドライバ。Mac の場合は [NVIDIA の CUDA ドライバ][28]
  * [NVIDIA cuDNN][29] 
      * NVIDIA 社の CUDA を利用した深層ニューラルネットワークのライブラリ。Tensorflow が画像の比較や遷移を GPU を用いて学習させるのに使われる。
  * [FaceSwap][30] @ GitHub 
      * 顔の置き換えツール。上記ライブラリを使って、画像から顔の抽出（Extract）、顔画像の学習を行い（Train）、指定されたフォルダにある画像の顔と入れ替え（Convert）と保存を行います。

## Deepfakes/FaceSwap の具体的な作り方 {#outline__8}

長い文章お付き合いいただきありがとうございます。さぁ、実際に作ってみましょう。
  
Happy Deeplearning!

<blockquote class="wp-embedded-content" data-secret="yC0hALA23S">
  <p>
    <a href="https://blog.keinos.com/20180207_3332">Deepfakes/FaceSwapの作り方 実施編 （Mac OSX）</a>
  </p>
</blockquote>

<iframe class="wp-embedded-content" sandbox="allow-scripts" security="restricted" style="position: absolute; clip: rect(1px, 1px, 1px, 1px);" src="https://blog.keinos.com/20180207_3332/embed#?secret=yC0hALA23S" data-secret="yC0hALA23S" width="600" height="338" title="&#8220;Deepfakes/FaceSwapの作り方 実施編 （Mac OSX）&#8221; &#8212; KEINOS™の日記" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe>

## 参考文献 {#outline__9}

  * 「[OpenCVで顔認識をしてみた][31]」 @ Qiita
  
    -「[画像処理ライブラリ OpenCV で 出来ること・出来ないこと][32]」 @ SlideShare
  * 「[10分で学ぶOpenCV超入門][33]」 @ moo.jp
  * 「画像処理をやるなら知らないと損！OpenCVがわかる資料まとめ」(https://career.levtech.jp/guide/knowhow/article/71/) @ levtech.jp

 [1]: #outline__8
 [2]: https://www.reddit.com/user/deepfakes/
 [3]: https://www.youtube.com/results?search_query=DeepFakes+Cage
 [4]: https://ja.wikipedia.org/wiki/%E3%82%A2%E3%82%A4%E3%83%89%E3%83%AB%E3%82%B3%E3%83%A9%E3%83%BC%E3%82%B8%E3%83%A5
 [5]: https://ja.wikipedia.org/wiki/VHS
 [6]: https://ja.wikipedia.org/wiki/Peer_to_Peer
 [7]: https://ja.wikipedia.org/wiki/Winny
 [8]: https://ja.wikipedia.org/wiki/%E9%87%91%E5%AD%90%E5%8B%87_(%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9E%E3%83%BC)
 [9]: https://ja.wikipedia.org/wiki/Winny%E4%BA%8B%E4%BB%B6
 [10]: https://ja.wikipedia.org/wiki/Napster
 [11]: https://ja.wikipedia.org/wiki/%E3%82%B7%E3%83%A7%E3%83%BC%E3%83%B3%E3%83%BB%E3%83%91%E3%83%BC%E3%82%AB%E3%83%BC
 [12]: https://en.wikipedia.org/wiki/Plaxo
 [13]: https://ja.wikipedia.org/wiki/Spotify
 [14]: https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%86%E3%82%A3%E3%83%BC%E3%83%96%E3%83%BB%E3%82%A6%E3%82%A9%E3%82%BA%E3%83%8B%E3%82%A2%E3%83%83%E3%82%AF
 [15]: https://gigazine.net/news/20180205-steve-wozniak-formula-happiness/
 [16]: https://twitter.com/hashtag/%E9%A1%94%E5%85%A5%E3%82%8C%E6%9B%BF%E3%81%88
 [17]: https://ja.wikipedia.org/wiki/Instagram
 [18]: https://ja.wikipedia.org/wiki/Twitter
 [19]: http://japanese.engadget.com/2017/04/10/ep9-cg/
 [20]: https://ja.wikipedia.org/wiki/%E3%82%B9%E3%82%BF%E3%83%BC%E3%83%BB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0_(%E5%B0%8F%E8%AA%AC%E3%83%BB%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%BB%E6%BC%AB%E7%94%BB)
 [21]: https://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%A9%E3%83%BC%E3%82%B8%E3%83%A5
 [22]: https://blog.keinos.com/20180207_3332
 [23]: https://ja.wikipedia.org/wiki/FFmpeg
 [24]: https://ja.wikipedia.org/wiki/OpenCV
 [25]: https://ja.wikipedia.org/wiki/TensorFlow
 [26]: https://ja.wikipedia.org/wiki/%E3%83%87%E3%82%A3%E3%83%BC%E3%83%97%E3%83%A9%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0
 [27]: https://ja.wikipedia.org/wiki/CUDA
 [28]: http://www.nvidia.co.jp/object/mac-driver-archive-jp.html
 [29]: https://developer.nvidia.com/cudnn
 [30]: https://github.com/deepfakes/faceswap/
 [31]: https://qiita.com/K_M95/items/f1a3e7c47800adb94095
 [32]: https://www.slideshare.net/FukushimaNorishige/opencv-67214568
 [33]: http://iphone.moo.jp/app/?p=1101