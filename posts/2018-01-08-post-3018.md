---
title: SSH接続で “No route to host” エラー時の確認事項
author: KEINOS
type: post
date: 2018-01-08T03:58:27+00:00
excerpt: 'ポート指定の SSH 接続で "ssh: connect to host sample.com port 12345: No route to host" が表示されてログインできない場合は、SSHの設定ファイル（２つ）でポートが適切に指定されていない可能性があります。'
url: /20180108_3018
featured_image: /wp-content/uploads/2017/06/unixlogo.png
yuzo_related_post_metabox:
  - 'a:3:{s:17:"yuzo_include_post";s:0:"";s:17:"yuzo_exclude_post";s:0:"";s:21:"yuzo_disabled_related";N;}'
page_type:
  - default
post_views_count:
  - 11373
description:
  - '変更したポートで SSH 接続をすると "connect to host sample.com port xxx: No route to host" が出た場合、ポートの変更が反映されていません。'
outline_none:
  - 1
categories:
  - CentOS
  - SSH
tags:
  - port
  - ssh.xml
  - sshd_config

---
## 現象（変更したSSH ポートにアクセスすると No route to host） {#outline__1}

> 「さくらのVPS」で SSH 接続のポート番号を変えたら接続できなくなった。
> 
> &#8220;`ssh -l keinos -p 12345 sample.com`&#8221;
    
> &#8220;sample.com&#8221; のポート &#8220;12345&#8221; に接続すると以下のエラーが出てログインできない。 

    ssh: connect to host sample.com port 12345: No route to host
    

## TL;DR（概要） {#outline__2}

`SSH` で接続する際に指定したポートが、**サーバー側の `SSH` ポートと合っていない**場合に `No route to host` エラーが発生します。

サーバー側の以下の２つのポート設定を確認してください。

  * サーバー側の `SSH` サービスのポート設定
  * サーバー側のファイアーウォールの許可設定で `SSH` のポートが上記と同じポート番号であるか

## TS;DR（詳細） {#outline__3}

例えば、接続先のサーバーが `CentOS7` の場合、下記２つのファイル（おそらく `ssh.xml` のほう）で**ポートの変更が反映されていない**と思われます。

  * `/etc/ssh/sshd_config`（SSH サービスの設定）
  * `/usr/lib/firewalld/services/ssh.xml`（ファイアーウォールの SSH 設定）

特に上記のファイルを変更後にアップデートを行った場合、**デフォルトの値（ポート 22番）に戻ってしまった**可能性があります。つまり、`yum clean all` `yum update` `yum --enablerepo=remi,remi-php56 update` などを行った場合です。

### サーバーを再起動したら設定が戻ってしまった {#outline__3_1}

経験上、サーバーの**サービスを再起動して動いたので変更を反映させたつもり**でも、OS の再起動により変更内容が上書きされた（元に戻った）ような挙動をすることがあります。

実際には、**サービスが起動中の設定変更であったために起きている現象**です。特にアップデートとポートの変更を１回で済まそうとすると顕著です。`_(:⁍」 )_`

また、「サービスの再起動とリロード」（`$ systemctl restart` と `$ systemctl reload`）を間違えている可能性もあります。

サーバーは、稼働しながらの設定変更を前提にしているのと、ディスクアクセスをなるべく減らすために、メモリ内に設定を保持しています。

そのため、`reload` しただけではメモリ内の設定情報を更新したにすぎず、逆に `reload` せずに `restart` したため、メモリ内の古い設定が使われていた、といった挙動になります。やっかいなのは、サービスやサービスのバージョンによって `restart` と同時に `reload` も行うものもあることです。

その上で気をつけたいのが「OS の再起動時の挙動」です。

どのサービスも、OS が起動するとディスク上の設定をメモリに読み込み、メモリ上の設定でサービスを稼働させます。以降サービスが参照するのは（基本的に）メモリ上の設定となります。

問題は、OS は再起動後も前回と同じ状態で動くことを優先するため、サービスによってはディスク上の設定とメモリ上の設定が異なる場合、終了時に上書きしてしまうことがあります。

それを避けるために、まずは `reload`（読み込み）でディスク上の設定とメモリ上の設定を同期し、次に `restart`（サービスの再起動）でメモリ上の設定を稼働しているサービスの設定と同期（反映）させるという手順が確実になります。

この３つの設定情報が同一でない場合に、「ポート変更時には動いていたのに再起動すると動かなくなった」となる原因の１つになります。

### サービスの設定と再起動の順序 {#outline__3_2}

まずは何はともあれ、**ポート番号を変更する前にアップデートと再起動を行う**ことから始め、**再起動後にポート番号の変更を行うのが確実**です。

次に、SSH のポート変更と、ファイアーウォールの SSH ポートの許可設定も行うのですが、これは同時でも構いません。

注意すべきは、サービス設定の読み込み順と、サービスの再起動の順番です。

`$ systemctl restart` と全てのサービスを一斉に再起動してしまうと、先に述べたようにサービスによってディスク上の情報を上書きして（元に戻して）しまう場合、意図しない挙動になりかねません。

「`SSH` サービスの再起動」→「ファイアーウォールの設定反映」→「ファイアーウォールのサービス再起動」の順番です。

  1. CentOS7 の SSH サービス（`sshd`）の再起動 
      * `$ sudo systemctl restart sshd`
  2. CentOS7 のファイアーウォールの設定反映 
      * `$ sudo firewall-cmd --reload`
  3. CentOS7 のファイアーウォルサービス（`firewalld`）の再起動 
      * `$ sudo systemctl restart firewalld`

### 失敗した場合 {#outline__3_3}

さくらのVPSの場合などのレンタル・サーバーの場合は、管理会社のサイトの管理画面からログインして「強制再起動」してみてください。

この時点でログインできなくなった場合は、すでに、クライアントからは SSH 経由でログインできないので、レンタル・サーバーの場合は管理画面のバーチャルコンソールやブラウザ版 FTP などを使って上記の２つのファイルを確認します。

### 切り分け {#outline__3_4}

  * パラメーターの指定があっているか（`-P` など大文字になっていないかなど）
  * ポート番号指定なしでどうか（`-p 22` と同等）
  * さくらのVPS の管理画面のコンソールでログインできるか（できた場合、以下を確認してどうか） 
      * `/etc/ssh/sshd_config` の `Port` 項目のポート番号と同じかどうか
      * `/usr/lib/firewalld/services/ssh.xml` の `<port protocol="tcp" port="xxxx"/>` 項目のポート番号と同じかどうか
  * FQDN ではなくグローバル IP アドレスでアクセスしてどうか
  * 他のユーザーでどうか（`root` など）

### 動作検証環境 {#outline__3_5}

  * CentOS linux release 7.4.1708 (Core)
  * さくらのVPS