---
title: SSH接続エラー時のメッセージ内容を変えられるのか（Permission deniedのカスタムメッセージ）
author: KEINOS
type: post
date: -001-11-30T00:00:00+00:00
excerpt: サーバーはエラーコードのみ返しており、メッセージの表示内容はクライアントに依存するため変更は不可能です。
draft: true
url: /?p=2686
yuzo_related_post_metabox:
  - 'a:3:{s:17:"yuzo_include_post";s:0:"";s:17:"yuzo_exclude_post";s:0:"";s:21:"yuzo_disabled_related";N;}'
page_type:
  - default
categories:
  - SSH
  - アルゴリズム・仕組み
tags:
  - BannerMessage

---
<div style="font-weight:bold;font-size:2em;padding:1em 0;">
  TL;DR
</div>

> サーバーは基本的にエラーコードのみを返しているので、メッセージの表示内容はクライアントに依存するためカスタマイズできません。 

この記事では、その仕組みやプロトコル仕様について説明したいと思います。

## エラーメッセージをカスタムしたい理由 {#outline__1}

以前、Qiitaで「[SSH接続する時（ログイン前）に警告メッセージを表示する方法」の記事を書いた][1]のですが、**ログイン失敗時のメッセージは変えられないか**と思いました。

特に、明らかにイタズラとわかるログインです。例えば、SSH接続不許可に設定されたユーザー（\`root\`や\`admin\`など）によるアクセスで、ポート番号を変更したのにわざわざポート・スキャンして接続してくるといったケースです。その場合、相手には「Permission denied (&#8230;(非許可理由)&#8230;)」メッセージが表示されるのですが、このメッセージと同時に警告文を発したいのです。

「そんな、サーバを建てている以上、ポートを触られるのは日常茶飯事で、ブロックする処理をきちんとしていればいいじゃないか」と私も思います。しかし、[Qiitaの記事にも書いた][1]のですが、実は法務的な対策や条例でログイン前には警告文を表示しないといけない国（対サイバーテロ法を制定している国）があり、公的機関が調査するためにも必要な文言らしいのです。

まぁ、そんなテロとか関係ないプライベートな（どうでもいい）サーバなので、単純に\`root\`でアクセスしてきたら「コラッ」と叱りたいだけなんですけどね。（詳しくは本文下記の所感を参照）

## プロトコル仕様 {#outline__2}

さて、SSH接続時のエラーに関して調べてみたところ、SSHポートにアクセス（ログイン前）に表示するメッセージについて、IETF（インターネットの国際標準を定義している団体）の「[RFC4252][2]」（SSH認証プロトコル）第５条４項で「Banner Message」として定義されているのを見つけました。

定義された動機も**法務的な面でのセキュリティ対策**のようですが、意外だったのが、これによると「バナー表示はデフォルトで表示」にすることが「[SHOUD][3]」（推奨）されていました。

つまり、「表示をデフォルト」にしておくことで、外したい場合には法務的な対策のリスクが伴うことを認識したうえで外すと

#### 所感 {#outline__2_0_1}

上記で、「法務的な対策で条例で」と述べましたが、実は調べたのには個人的な理由があって、最近話題のマストドンの俺様インスタンスを実験的に建てたのですが、何故かメチャクチャいたずら（22番ポートにrootで執拗にアクセスをトライ）してくる人がいるのです。DenyHostsがインストールされているので自動的にIPをブロックしてくれてはいるのですが、IPを変えては同じいたずらをしてくるのです。

毎週月・水・金の同じ時間（３時、６時、20時）に、80番ポートを3回、8080番ポートを２回、ランダムなベーシック認証でアクセスしてきて、その３秒後に２２番ポートを1０回以上（ブロックしちゃうので上限はわからないのですが、rootでパスワードはリストなのか毎回同じ順番でログインを）しつこくチャレンジしてきて、いずれも[Tor経由のアクセス][4]という、明らかに行動パターンが同じイタズラをされます。

ちょっと感情的な文になってしまいましたが、ログを開くたびに「**毎日学校帰りのガキにピンポンダッシュをされる頑固ジジイの気分**」がわかる感じです。ネットなので怒鳴ることは出来ないのですが、警告文であればイメージ的にも怒鳴ってるのかなぁと。まぁ、そんな程度です。

 [1]: http://qiita.com/KEINOS/items/e6da8ed42167fa632c84
 [2]: https://www.ietf.org/rfc/rfc4252.txt
 [3]: https://www.ipa.go.jp/security/rfc/RFC2119JA.html
 [4]: https://check.torproject.org/exit-addresses