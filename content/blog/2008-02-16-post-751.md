---
title: 私のGeeklogのMVC的使い方（WebAPI化）
author: KEINOS
type: post
date: 2008-02-15T16:08:50+00:00
url: /20080216_751
featured_image: /wp-content/uploads/2016/11/geek_1479662362.jpg
page_type:
  - default
post_views_count:
  - 209
categories:
  - Geeklog
  - PHP
tags:
  - API
  - MVC
  - WEBサービス

---
> 2013/09/11 追記：5年半前の記事ですっかり放置していたのですが、なんと恐れ多くもGeeklogのivyweさんからコメントをいただきました。m(_ _;)m ガクガクブルブル
すっかり KEINOS は Geeklog 離れしていたのですが、その後も Geeklog の活動は続けられており、昨今の WordPress のセキュリティ問題も多いことから、Geeklog を再考するのもアリかも。
記事にある重かったのって単純にロリポップの SQL サーバがダメダメだっただけで、5年前と比べてデザイナ（兼 HTML コーダーさん）もテンプレートの役割もわかって来ているし。もう一度見直してみよう。

## Geeklog を WEB サービス的に API 化する

![](https://blog.keinos.com/wordpress/wp-content/uploads/2016/11/geek_1479662362-238x300.jpg)

Geeklog ってテンプレートのメンテナンスというかカスタマイズというか、全体的に改修しづらい。

しかもロリポップの MySQL のサーバで外れを引いてしまったのか、遅い。いやー重い。

それでも、そのセキュリティに対するこだわり方が気に入ったので、トレードオフと割り切って、とある環境で使ってみることにしたんです。

Geeklog の情報も Ivy さんたちが精力的に発信してくれて情報も多いのですが、記事のタイトルにすべてサイト名が頭に付いているため検索しづらかったり、サイトが崩れて見れなかったり、説明がデザイナさんではわかりづらかったりで、その都度「どういうことか」と聞かれそうなのも大変でさ。

かといって情報を見つけてもらったところで、結局 Geeklog では PHP ができる人でないとデザインに柔軟性がないことを実感したんです。

でも、その管理機能としてはプラグイン好きなワタシとしては満足していたりします。

ただね、実は**毎月デザインを変えないといけない環境で利用している**んです。(T_T)/~~~

自分が言いだしっぺなんだけども。

でも、やっぱり流行というか [MVC モデル](http://ja.wikipedia.org/wiki/Model_View_Controller)的に管理したいじゃない？クールにさ。

そこで、Geeklog はフロントエンドとしてではなく、コンテンツの管理用だけに利用しています。そして表示は別システムで行っています。

これは、コンテンツ管理のシステムを Geeklog から他の CMS に（XOOPS でもMTでもなんでもいいんだけど）移管したとしても、フロントエンドを変えなくてもいいようにという意味もあるんです。

### Geeklogのデザインを完全に独立させる

実は、上記の「別システム」がフロントエンドとして機能（デザインに特化）していて、やっている仕組みは簡単。

- View（表示）<br /> フロントエンドに<a href="http://smarty.karakuriya.biz/smarty/000325.html">Smarty</a>を使って、デザイナさんが管理しやすい環境を作る。
- Controller（管理）<br /> Modelに表示したい記事のIDをリクエストして、返ってきたデータをViewerに渡す。
- Model（データ）<br /> GeeklogをWEBサービス的にAPI化させて、リクエストされた記事IDの記事データを返す。

ほら、結局、記事に必要な最低限のデータって、

- タイトル
- 概要(description)
- 本文(contents)
- 更新日
- 作成日

程度じゃない？それを基準に上記のように機能をわけたんです。

トラックバックとか、記事に記載された画像とかリンクとかの処理も必要だけど、URL も決まってるから置換でなんとかなるし。

Smarty も、ロリポップで標準で使えるテンプレートエンジンだし、何より昔から使いまわしているクラスを利用したくて。

もぅチト、詳しく説明すると

WEB サービスにおける API の基本としては、POST なり GET なりでリクエストを受けると、その結果を特定フォーマットで返す（表示する）というシンプルなもの。

そこで、Geeklog 側の `story.php` をカスタムして、`story` の `ID`（記事 ID）を POST でリクエストを受けると、記事の表示に必要なデータだけを配列に入れて `serialize` したものを返しているだけです。

### 参考文献

- [Yahoo曰く、XMLじゃなくてPHPの変数をそのままシリアライズして返せばいいじゃん](http://neta.ywcafe.net/000544.html)
- [file_get_contentsでPOSTデータ送信](http://d.hatena.ne.jp/ryster/20070907/1189148449)

でも、せっかくのセキュリティに強いというGeeklogなので、ここで穴を作っちゃうのもナニだから、このカスタムしたGeeklogのstory.phpにベーシック認証をかまして、データもPEARのCriptを使って暗号化しています。なんとなくその方がカッコイイかなと思って。

リクエストする側（`Controller`)は、`file_get_contents()` 関数で `storyID` を上記のなんちゃって `API` に投げて、その返って来たデータをDecriptして、unserializeして配列に戻します。

これをテンプレートに流す。

これだけ。

もう気分は WEB サービスの API っすよ。えぇ。

でも、これで View（Smarty）側でキャッシュを ON にして劇的に表示が軽くなりました。都度 Geeklog が MySQL をほじりに行かなくなるので。

また、デザインの管理もしやすくなったし。Controler は API 経由でデータを受け取るので、Geeklog からオリジナルの CMS に移管しても大丈夫な準備もできた。

### 最後に

けど、最初からこの仕組みを考えてた訳ではなくて、Geeklog 導入後、運営上「チーッとやばいかもかも…」という懸念が出てきたからなんです。

気付いたら MVC モデル的な仕組みになって、「お、MVC モデルになってんじゃん」と棚ボタ的に記事を書いてみました。

この記事が保守のための情報になれば、これ幸いです。
