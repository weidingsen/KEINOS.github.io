---
title: 「このiPhoneを承認できませんか？」と「暗号化されたデータをリセット」を求められる
author: KEINOS
type: post
date: 2018-08-09T03:26:49+00:00
excerpt: iOS のアップデートなどで「このiPhone/iPadを承認」画面で反応がなく承認できない場合、「エンドツーエンドの暗号化データをリセット」を行っても新たに暗号化データが作成されるのでリセットを行っても大丈夫です。
url: /20180809_4078
yuzo_related_post_metabox:
  - 'a:3:{s:17:"yuzo_include_post";s:0:"";s:17:"yuzo_exclude_post";s:0:"";s:21:"yuzo_disabled_related";N;}'
post_views_count:
  - 15619
outline_none:
  - 1
categories:
  - iOS
tags:
  - iPhone/iPad
  - ２ファクタ認証
  - ２段階認証/２ステップ認証

---
## TL;DR（概要） {#outline__1}

### 暗号化されたデータをリセット…怖いっ！ {#outline__1_1}

> 【このiPhoneを承認できませんか？】
    
> このiPhoneを別のデバイスから承認できない場合は、エンドツーエンドの暗号化データをリセットしてiCloudの設定を完了することができます。
    
> -「暗号化されたデータをリセット」
    
> -「キャンセル」 

と、鬼の選択を迫られた場合、怖くて押せないと思いますが、にっちもさっちも進まない人は**「暗号化されたデータをリセット」しましょう**。

iPhone 内の**古い暗号化データがリセットされ改めて暗号化されたデータが作成されます**。

### 原因 {#outline__1_2}

> 「２ファクタ認証」を有効にしたことにより iCloud 上の一部のデータが Apple でも読めない暗号化された状態に変わったため。 

これにより、暗号データの解読（復号）に必要な情報を持っていない他のデバイスでは、受け取った認証の命令を解読できず反応しなくなります。

「暗号化されたデータをリセット」することで、復号に必要な情報、つまり「鍵」（暗号用の長いパスワード）が作られ、暗号化された iCloud の情報を読み込むことができるようになります。

詳しくは TS;DR をご覧ください。

## TS;DR（詳細な説明） {#outline__2}

### このiPhoneを承認…できない！ {#outline__2_1}

台風が来てるので、部屋の片付けの合間に、溜まりに溜まった **iPhone のアップデートをしようとした**ところ、「例の画面」が出ました。

> 【このiPhoneを承認】
    
> iCloudにサインインしているほかのいずれかのデバイスで、このiPhoneを承認してください。
                 
> 現在承認待ちです &#8230;
    
> &#8211; [このiPhoneを承認できませんか？] 

いつもは別のマイ iPad が反応し「許可」ボタンを押していました。

  * iPad「&#8230;」
  * 私「&#8230;」
  * iPad「&#8230;」
  * 私「&#8230;」
  * iPad「&#8230;」
  * 私「フーンヌーー！！」

(╯´>ω<\`）╯︵ ┻━┻

待てど暮らせど、再起動しようが、WiFi をオン・オフしようが iPad が反応しません。

仕方がないので「この iPhone を承認できませんか？」「そうですか、できませんか」と独り言を言いながらポチッ。

すると、いつもなら「あとで承認」とか出るはずが「暗号化されたデータをリセット」と「キャンセル」しかできません。

> 【このiPhoneを承認できませんか？】
    
> このiPhoneを別のデバイスから承認できない場合は、エンドツーエンドの暗号化データをリセットしてiCloudの設定を完了することができます。
    
> -「暗号化されたデータをリセット」
    
> -「キャンセル」 

「暗号化データ？」と説明文を読んでもよくわからず焦ってしまいます。

「承認できませんか？あーそうですか」と**安易にリセットを押せるような内容ではない**、なんか怖い文です。データ消えちゃいそう😱

### ２ファクタ認証を無効に…できない！ {#outline__2_2}

ネットには「２ファクタ認証を有効（オン）にしていると、この現象が出る」っぽいことが書いてありました。

  * 『[「このiPhoneを承認」画面がずっと「現在承認待ちです…」から進まなくなった場合の対策について][1]』 @ 情報科学屋さんを目指す人のメモ

そこで、[Apple ID のサイト][2]に行って「セキュリティ」の編集内にある「２ファクタ認証」をみると**「オン」と書かれたままで選択や変更もできません**。「２ファクタ認証を無効にする」すらありません。そもそも、２段階認証を有効にした記憶もありません。

ん？「ファクタ」って「段階」って意味だっけか？

#### 「２段階認証」と「２ファクタ認証」は別物 {#outline__2_2_1}

「２段階認証」つまり英語で言うと「２ステップ認証」と「２ファクタ認証」って違うものなのか疑問に思い調べてみました。すると、[「２段階認証」と「２ファクタ認証」は似て非なる別の機能][3]とのこと。

> 【Apple が現状提供している 2 ステップ確認機能とは違うのですか？】
    
> はい。2 ファクタ認証は、iOS、macOS、tvOS、watchOS、Apple の Web サイトに直接組み込まれています。従来とは違う手法でデバイスを信頼し、確認コードを配信します。また、お客様には一層効率的にご利用いただけるようになっています。セキュリティ強化が求められる特定の機能を使う場合は、2 ファクタ認証が必須となります。
    
> 従来の 2 ステップ確認機能は別途、すでにご利用いただいているお客様には継続してお使いいただけます。 

  * [Apple ID の 2 ファクタ認証][4] @ Apple

２ステップ だか ２ファクタ だか 小難しいダンスステップ を教わっているかのようです。しかも、よくよく読むと小さく「デフォルトで**２ファクタ認証が「オン」になるケースがある**らしい」ことが書かれています。

> iOS 10.3 および macOS 10.12.4 以降で作成した一部の Apple ID は、最初から 2 ファクタ認証で保護されています。この場合、2 ファクタ認証が「オン」と表示されます。 

おそらく私の現象はこれだと思うのですが、この「２ステップ認証」と「２ファクタ認証」の違いで誤動作している人もいるんではないかしら。

  * [2 ステップ確認から 2 ファクタ認証に切り替える手順][5] @ Apple

「２ステップ認証」とは世界標準とも言える「２段階認証」、つまり Google, Facebook, LINE などのように「ログインなどの認証に別の端末を通して認証する」方式なのですが、上記の手順を見てわかったのが**「２ファクタ認証」とは Apple の端末限定の縛りをつけた認証**で、「２ステップ認証」の Apple 拡張版と言えそうです。

### 端末の位置情報が…変っ！ {#outline__2_3}

気になったのは、AppleID にログインするとマップに表示される**端末の位置情報がおかしい**のです。

> 【Apple ID サインインが要求されました】
    
> ご利用の Apple ID が███区███付近でデバイスにサインインするために使用されています。
    
> &#8211; [許可しない]
    
> &#8211; [許可する] 

「ん？うちは██区で全然違う場所なんですけど・・・」

数ブロックずれてるというレベルではない規模のズレです。

iPad や iPhone に限らず最近の OS やアプリは、**「従来の行動パターンと違う」と判断すると別の端末に確認する**ことがあります。インターネット・カフェなどからログインするとメールや iPhone にポーンと確認がくる、アレです。

自宅のプロバイダの会社と思わしき住所が位置情報として表示される場合は、IP アドレスからのみ位置情報を割り出している（＝プロバイダの位置情報）ということなので、GPS と WiFi がうまく動いていない可能性があります。というのも**スマホは IP アドレス, GPS, 他の WiFi のアンテナを総合して位置情報を割り出す**ためです。

つまり、位置情報が「いつもと違う場所からアクセスしている」と、怪しいと思われて**その機能が働いたのかもしれない**と思い、以下の定石の操作を行いました。

  1. 電源とホーム・ボタン長押しで完全再起動
  2. 「コンパス」アプリを開いてグルグルと動かして位置調整（キャリブレーション）
  3. WiFi の確認
  4. マップ・アプリで位置確認
  5. 「iPhone を探す」アプリで iPhone と iPad の位置確認

どれも問題なかったので、改めて iPhone のアップデートを行いましたが、残念ながら、やはり他のデバイスからの認証待ちで止まってしまいます。

やはり、、、「暗号化されたデータをリセット」するしかないの、か？

台風で外出れないし、いまデータ飛んだら、意識も飛んじゃうわのよ。あちょんぶりけ。

### エンドツーエンドの暗号化データとは {#outline__2_4}

そもそも「エンドツーエンドの暗号化データ」って何よ、と思い調べてみました。

  * [iCloud のセキュリティの概要][6] @ Apple

上記 Apple のサイトに以下のような記述がありました。

> iCloud では、業界標準のセキュリティ技術を採用し、厳格なポリシーに則って個人情報を保護しています。また、エンドツーエンドのデータ暗号化などのプライバシー保護技術を取り入れて、業界を牽引する存在にもなっています。 

ふむふむ。わからん。

「Apple がマニュアルを同梱しないのは、こういったことを書いてもユーザが理解できないと思ってる」から、としか思えない難しさ。とりあえず Apple すごいと自賛していることはわかりました。

どうやら、先の「２段階認証」と「２ファクタ認証」が、「世界標準」の認証方法と「Apple 独自」の認証方法であったように、「世界標準」の暗号技術を元に **「Apple 独自」の暗号技術として「エンドツーエンドのデータ暗号化」がある**ようです。

> 【エンドツーエンドで暗号化されたデータ】
    
> エンドツーエンドの暗号化なら、最高水準のデータセキュリティを確保できます。デバイスに固有の情報から派生した (本人しか知り得ない) キーをデバイスのパスコードと組み合わせて、データが保護されます。このデータにはほかのだれもアクセスしたり、読み取ったりすることができません。 

これも、わかるようでわからない。賢いルー語のようです。

そこで、まずは「エンドツーエンド」の言葉を理解する必要がありそうです。

「End To End」は「終わりから終わり」というより「末端から末端」という意味です。コンピューターの世界では、（ソフトウェアやハードウェアなどの）**商品を最終的に触る利用者のことを「エンド・ユーザー」と呼ぶ**のですが、説明文を読む限り「エンドツーエンド」は「エンドユーザー To エンドユーザー」の意味だと思われます。

というのも「(本人しか知り得ない) キー」とあるので、「本人」とは商品を触っているエンドユーザー（所有者）を指すからです。

> ほかのだれもアクセスしたり、読み取ったりすることができません。 

や

> ほかのだれも、たとえ Apple でも、エンドツーエンドで暗号化された情報にはアクセスできません。 

とあることから、自分自身（エンドユーザー）と他人（エンドユーザー）の暗号化でもないようです。

つまり**「End To End の暗号化データ」とは「自分から自分への暗号化されたデータ」**と解釈できます。

### データを暗号化する理由 {#outline__2_5}

本題の「リセット」を聞いてくるメッセージをもう一度確認してみましょう。

> 【このiPhoneを承認できませんか？】
    
> このiPhoneを別のデバイスから承認できない場合は、エンドツーエンドの暗号化データをリセットしてiCloudの設定を完了することができます。
    
> -「暗号化されたデータをリセット」
    
> -「キャンセル」 

逆に言うと「暗号化データをリセットしないと iCloud の設定を完了できない」ということです。つまり、**このメッセージが表示されるのは iCloud がらみの設定**ということがわかります。

iCloud の基本的な仕組みとして、iPhone や iPad などに入っているデータを暗号化して Apple に送信します。

これは、ネットワーク管理者や悪意ある社員などが**ネットワークを盗聴してもデータが暗号化されていることで中身を読めなくするため**です。

暗号化したものを元に戻すことを「復号」と言いうのですが、Apple は**受け取った暗号化データを復号して AppleID に反映させたり iCloud に保存する**のです。しかし、データによっては **Apple に復号されずに暗号化されたまま iCloud に保存したい**と思うこともあると思います。つまり、Apple に「覗いて欲しくないが保存はして欲しい」状態です。

これを実現するためには、暗号化に必要なパスワードを２つ用意する必要があります。

  1. 自分だけがわかるパスワード
  2. Apple と自分が使えるパスワード

つまり、自分だけがわかるパスワード（1）でデータを暗号化し、それをさらに Apple と自分がわかるパスワード（2）で暗号化した、２重に暗号化されたデータを Apple に送るイメージです。

この前者（1）による暗号化、つまり「iCloud には保存はされるも自分だけしかわからないパスワード」で暗号化されたままのデータが「エンドツーエンドの暗号化データ」となります。

しかし AppleID のパスワードは、ただでさえ複雑です。すでにたくさんのパスワードを覚えないといけないなか、また新たに AppleID レベルの複雑なパスワードを覚えるも大変です。使い分けも面倒です。（絶対わからなくなる人が出てくるのは自明です）

そこで、「Apple と自分の両者が使えるパスワード」をまずユーザーに考えてもらい、そのパスワードを元に自分の端末の様々な情報を組み合わせて「自分だけの環境で作られたパスワード」を別途作ることで、ユーザーは最初の１つのパスワードさえ覚えておけばいい状態にしました。

※ 厳密には単純にパスワードで暗号化するわけではなく、パスワードを元に作成された、長いパスワード・ファイルで暗号化されます。これを「鍵」（キー）と呼びます。

これを Apple が説明したのが以下の文です。

> 【エンドツーエンドで暗号化されたデータ】
    
> エンドツーエンドの暗号化なら、最高水準のデータセキュリティを確保できます。デバイスに固有の情報から派生した (本人しか知り得ない) キーをデバイスのパスコードと組み合わせて、データが保護されます。このデータにはほかのだれもアクセスしたり、読み取ったりすることができません。 

  * [iCloud のセキュリティの概要][6] @ Apple

### どんなデータが暗号化されるのか {#outline__2_6}

まず、iCloud 含む **Apple との通信はすべて暗号化されます**。

問題は iCloud に「エンドツーエンドで暗号化されたデータ」、つまり個人の「鍵」（※）で暗号化されたまま保存されるデータですが、[Apple の公開情報][6]によると以下の通りです。（※ 先述した「1. 自分だけの長いパスワード・ファイル」のこと）

  * ホームのデータ
  * ヘルスケアデータ
  * iCloud キーチェーン (保存済みのアカウントやパスワードもすべて該当します)
  * お支払い情報
  * Siri の情報
  * Wi-Fi ネットワーク情報

上記以外の iCloud 上のデータは暗号化はされているのですが、AppleID つまり「Apple と自分が使えるパスワード」で暗号化されたデータです。

このように、上記は暗号化されたまま iCloud に保存されるのですが、逆に言うと**「自分の鍵」がないと復号できないデータ**でもあるということです。

当然のような話しなのですが重要です。と言うのも**「鍵」が壊れたり異なる場合は復号できなくなる**からです。

### なぜデータをリセットしないといけないのか {#outline__2_7}

「自分の鍵」は**自身のデバイスで各々作成されます**。この時、パスコード（画面を解除する４桁のコードなど）や iCloud に使っているメールアドレス、デバイスの情報などを（具体的には秘密らしいのですが）組み合わせて作られます。

これが「たとえ Apple でも、エンドツーエンドで暗号化された情報にはアクセスできません。」と言う理由です。

しかし、メモリやハードディスクは消耗品です。空き容量が少ないと動作が不安定になりデータもちゃんと保存できないこともあります。そして、それらが原因で「自分の鍵」が壊れたりする可能性もあります。また、「鍵」を作る要素（例えばパスコードなど）が変わった場合にも「自分の鍵」は使えなくなります。

そのような事態が発生した場合は、改めて**「自分の鍵」を作り直し iCloud 上のデータを、新しい「自分の鍵」で暗号化されたものに更新する**必要があります。

これら一連の「エンドツーエンドの暗号化」は「Apple ID に対し、2 ファクタ認証を有効にしておく必要があります」。逆に言うと「２ファクタ認証」を有効にすると「エンドツーエンドの暗号化」が行われるということです。

ここが本記事のテーマである「暗号化データをリセット」する必要性につながります。

例えば、Mac 上から「２ファクタ認証」を有効にした場合、その時点では他の iPhone や iPad 内には「自分の鍵」がありません。しかし、iCloud 上のデータは、すでに「エンドツーエンドの暗号化データ」に変わっているのと、Apple とデバイス間の通信も新しい鍵で行われるので iCloud を通して他のデバイスに通知が行かなくなるのです。（各デバイスから Apple へは古い各々の鍵で通信はできます）

このような状態の場合、iPhone や iPad も各自が「自分の鍵」を作成して各自の iCloud 情報を更新しないとなりません。これが「エンドツーエンドの暗号化データをリセットして iCloud の設定を完了」させるという意味です。

逆に言えば「２ファクタ認証」を無効にすれば、エンドツーエンドで暗号化されたデータは元に戻されるので、「自分の鍵」を持っていない他の端末でも iCloud が使える状態に戻るということでもあります。

これが、ずいぶん先に触れた「２ファクタ認証を一時的に無効にすると動作する（ことがある）」という理由です。

以上から「エンドツーエンドの暗号化データをリセット」を行っても大丈夫と言えそうです。

> 「エンドツーエンドの暗号化データをリセット」を行っても、改めて「自分の鍵」が作成され iCloud 上のデータと手元のデバイスの iCloud 情報が更新されることで、同期が完了するので、リセットを行っても大丈夫。

 [1]: https://did2memo.net/2018/02/25/iphone-kono-iphone-wo-shounin/
 [2]: https://appleid.apple.com/
 [3]: https://support.apple.com/ja-jp/HT204915#FAQ
 [4]: https://support.apple.com/ja-jp/HT204915
 [5]: https://support.apple.com/ja-jp/HT207198
 [6]: https://support.apple.com/ja-jp/HT202303